import React, { useState, useEffect, useRef } from "react";

// Single-file React component for the Moments app with:
// - Facebook-like color theme
// - Strong password enforcement on signup
// - Timeline creation modal with configuration and a start date
// - Posts accept custom datetime (can be future) and timelines order posts by time
// - Small UX polish and clearer affordances

const uid = () => Math.random().toString(36).slice(2, 9);

// Storage keys
const USERS_KEY = "moments_users";
const SESSION_KEY = "moments_session";
const TIMELINES_KEY = "moments_timelines";
const MESSAGES_KEY = "moments_messages";

function read(key) {
  try {
    return JSON.parse(localStorage.getItem(key)) || {};
  } catch {
    return {};
  }
}
function write(key, val) {
  localStorage.setItem(key, JSON.stringify(val));
}

function ensureUserShape(u) {
  if (!u.friends) u.friends = [];
  if (!u.pendingRequests) u.pendingRequests = [];
  if (typeof u.isStar === "undefined") u.isStar = false;
  return u;
}

function createAccount(username, password, isStar = false) {
  const users = read(USERS_KEY);
  if (users[username]) throw new Error("username taken");
  users[username] = ensureUserShape({ username, password, id: uid(), friends: [], pendingRequests: [], isStar });
  write(USERS_KEY, users);
}
function signIn(username, password) {
  const users = read(USERS_KEY);
  if (!users[username]) throw new Error("no such user");
  if (users[username].password !== password) throw new Error("wrong password");
  write(SESSION_KEY, { username });
  return users[username];
}
function signOut() {
  localStorage.removeItem(SESSION_KEY);
}
function currentSession() {
  return read(SESSION_KEY);
}

// Friend request helpers (unchanged)
function sendFriendRequest(from, to) {
  const users = read(USERS_KEY);
  if (!users[to]) throw new Error("no such user");
  users[to] = ensureUserShape(users[to]);
  users[to].pendingRequests = users[to].pendingRequests || [];
  if (!users[to].pendingRequests.includes(from) && !users[to].friends.includes(from)) {
    users[to].pendingRequests.push(from);
    write(USERS_KEY, users);
  }
}
function acceptFriendRequest(acceptor, fromUser) {
  const users = read(USERS_KEY);
  if (!users[acceptor] || !users[fromUser]) return;
  users[acceptor].pendingRequests = (users[acceptor].pendingRequests || []).filter(u => u !== fromUser);
  if (!users[acceptor].friends.includes(fromUser)) users[acceptor].friends.push(fromUser);
  if (!users[fromUser].friends.includes(acceptor)) users[fromUser].friends.push(acceptor);
  write(USERS_KEY, users);
}
function declineFriendRequest(decliner, fromUser) {
  const users = read(USERS_KEY);
  if (!users[decliner]) return;
  users[decliner].pendingRequests = (users[decliner].pendingRequests || []).filter(u => u !== fromUser);
  write(USERS_KEY, users);
}
function getFriends(user) { const users = read(USERS_KEY); return users[user]?.friends || []; }
function getPendingRequests(user) { const users = read(USERS_KEY); return users[user]?.pendingRequests || []; }

// Password strength validator — adjustable rules. Here: min 10 chars, upper, lower, digit, special
function isStrongPassword(pw) {
  if (!pw || pw.length < 10) return false;
  if (!/[a-z]/.test(pw)) return false;
  if (!/[A-Z]/.test(pw)) return false;
  if (!/[0-9]/.test(pw)) return false;
  if (!/[\W_]/.test(pw)) return false;
  return true;
}

// ---------------- App ----------------
export default function MomentsApp() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState("timelines");
  const [timelines, setTimelines] = useState(read(TIMELINES_KEY));
  const [messages, setMessages] = useState(read(MESSAGES_KEY));
  const bc = useRef(null);

  useEffect(() => {
    const s = currentSession();
    if (s?.username) {
      const users = read(USERS_KEY);
      if (users[s.username]) setUser(users[s.username]);
    }
  }, []);

  useEffect(() => {
    bc.current = new BroadcastChannel("moments_channel");
    bc.current.onmessage = (e) => {
      if (e.data.type === "timelines_update") setTimelines(read(TIMELINES_KEY));
      if (e.data.type === "users_update") {
        const s = currentSession();
        if (s?.username) setUser(read(USERS_KEY)[s.username]);
      }
      if (e.data.type === "message") setMessages(read(MESSAGES_KEY));
    };
    return () => bc.current && bc.current.close();
  }, []);

  function saveTimelines(updated) {
    setTimelines(updated);
    write(TIMELINES_KEY, updated);
    bc.current && bc.current.postMessage({ type: "timelines_update" });
  }
  function saveUsers(usersObj) {
    write(USERS_KEY, usersObj);
    bc.current && bc.current.postMessage({ type: "users_update" });
  }

  // Timeline creation now uses a modal with configuration including a start date and visibility
  function handleCreateTimeline({ name, iconDataUrl, locked = false, startDate = Date.now(), description = "" }) {
    const newT = { id: uid(), name, owner: user.username, posts: [], locked, icon: iconDataUrl || null, startDate, description };
    const updated = { ...timelines, [newT.id]: newT };
    saveTimelines(updated);
  }

  // Adding a post: now allows specifying datetime (future allowed)
  function handleAddPost(tid, { content, type = "text", createdAt = Date.now() }) {
    const t = { ...timelines[tid] };
    const newPost = { id: uid(), owner: user.username, type, content, created: createdAt };
    t.posts = [...t.posts, newPost].sort((a, b) => new Date(a.created) - new Date(b.created));
    const updated = { ...timelines, [tid]: t };
    saveTimelines(updated);
  }

  function handleDeletePost(tid, pid) {
    const t = { ...timelines[tid], posts: timelines[tid].posts.filter(p => p.id !== pid) };
    const updated = { ...timelines, [tid]: t };
    saveTimelines(updated);
  }

  function toggleLock(tid) {
    const t = { ...timelines[tid] };
    t.locked = !t.locked;
    const updated = { ...timelines, [tid]: t };
    saveTimelines(updated);
  }

  function sendMessage(to, text) {
    const msg = { from: user.username, to, text, time: Date.now() };
    const m = { ...messages };
    if (!m[user.username]) m[user.username] = {};
    if (!m[user.username][to]) m[user.username][to] = [];
    m[user.username][to].push(msg);

    if (!m[to]) m[to] = {};
    if (!m[to][user.username]) m[to][user.username] = [];
    m[to][user.username].push(msg);

    setMessages(m); write(MESSAGES_KEY, m);
    bc.current && bc.current.postMessage({ type: "message", to, from: user.username, msg });
  }

  function requestAddFamily(targetUsername) {
    try {
      sendFriendRequest(user.username, targetUsername);
      const users = read(USERS_KEY);
      write(USERS_KEY, users);
      bc.current && bc.current.postMessage({ type: "users_update" });
      alert("Friend request sent.");
    } catch (e) { alert(e.message); }
  }

  function acceptRequest(fromUser) {
    acceptFriendRequest(user.username, fromUser);
    const users = read(USERS_KEY);
    write(USERS_KEY, users);
    bc.current && bc.current.postMessage({ type: "users_update" });
    const session = currentSession();
    if (session?.username) setUser(read(USERS_KEY)[session.username]);
  }
  function declineRequest(fromUser) {
    declineFriendRequest(user.username, fromUser);
    const users = read(USERS_KEY);
    write(USERS_KEY, users);
    bc.current && bc.current.postMessage({ type: "users_update" });
    const session = currentSession();
    if (session?.username) setUser(read(USERS_KEY)[session.username]);
  }

  return user
    ? <Dashboard user={user} setUser={setUser} view={view} setView={setView} timelines={timelines} messages={messages} sendMessage={sendMessage} handleCreateTimeline={handleCreateTimeline} handleAddPost={handleAddPost} handleDeletePost={handleDeletePost} toggleLock={toggleLock} requestAddFamily={requestAddFamily} acceptRequest={acceptRequest} declineRequest={declineRequest} saveUsers={saveUsers} />
    : <AuthPanel setUser={setUser} />;
}

// ------------------ UI / Components ------------------

// Theme helpers: facebook blue
const fb = {
  blue: "#1877F2",
  dark: "#0b57d0",
  light: "#e8f0ff",
};

function AuthPanel({ setUser }) {
  const [mode, setMode] = useState("signin");
  const [u, setU] = useState("");
  const [p, setP] = useState("");
  const [err, setErr] = useState("");
  const [isStar, setIsStar] = useState(false);
  const [showWarning, setShowWarning] = useState(false);

  function submit(e) {
    e.preventDefault();
    try {
      setErr("");
      if (mode === "signup") {
        if (!isStrongPassword(p)) throw new Error("Password not strong enough. Use at least 10 chars with upper, lower, number and symbol.");
        if (isStar) { setShowWarning(true); return; }
        createAccount(u, p, false);
      }
      signIn(u, p);
      setUser(read(USERS_KEY)[u]);
    } catch (e) { setErr(e.message); }
  }

  function confirmStarSignup() {
    try {
      createAccount(u, p, true);
      signIn(u, p);
      setUser(read(USERS_KEY)[u]);
      setShowWarning(false);
    } catch (e) { setErr(e.message); setShowWarning(false); }
  }

  return (
    <div style={{ maxWidth: 520, margin: '36px auto' }} className="p-6 bg-white rounded-xl shadow">
      <div className="flex items-center gap-4 mb-4">
        <div style={{ width: 48, height: 48, borderRadius: 10, background: fb.blue }}></div>
        <h2 className="text-2xl font-bold">Moments</h2>
      </div>

      <h3 className="text-lg font-semibold mb-2">{mode === "signin" ? "Sign in" : "Create account"}</h3>
      <form onSubmit={submit} className="space-y-3">
        <input className="w-full p-3 border rounded" placeholder="username" value={u} onChange={e => setU(e.target.value)} />
        <input className="w-full p-3 border rounded" placeholder="password" type="password" value={p} onChange={e => setP(e.target.value)} />

        {mode === "signup" && (
          <label className="flex items-center gap-2 text-sm">
            <input type="checkbox" checked={isStar} onChange={e => setIsStar(e.target.checked)} />
            Join the Star Program (unlocked posts are public)
          </label>
        )}

        {err && <div className="text-red-600 text-sm">{err}</div>}

        <button style={{ background: fb.blue }} className="w-full px-3 py-2 text-white rounded">{mode === "signin" ? "Sign in" : "Sign up"}</button>
      </form>

      <div className="mt-3 flex justify-between items-center">
        <button onClick={() => setMode(mode === "signin" ? "signup" : "signin")} className="px-3 py-2 border rounded">{mode === "signin" ? "Need an account? Sign up" : "Have an account? Sign in"}</button>
        <small className="text-slate-500">Strong pw required on signup</small>
      </div>

      {showWarning && (
        <div className="fixed inset-0 flex items-center justify-center bg-black/40 p-4">
          <div className="bg-white rounded p-4 max-w-md w-full">
            <h3 className="font-bold mb-2">Star Program — public visibility</h3>
            <p className="text-sm mb-3">By joining the Star Program, any timeline posts you leave unlocked will be visible to everyone (this site is local-only for testing, but unlocked posts are public to all users on this device). Are you sure you want to continue?</p>
            <div className="flex gap-2 justify-end">
              <button onClick={() => setShowWarning(false)} className="px-3 py-1 border rounded">Cancel</button>
              <button onClick={confirmStarSignup} className="px-3 py-1 rounded" style={{ background: '#ffeb9c' }}>Yes, join Star Program</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function Dashboard({ user, setUser, view, setView, timelines, messages, sendMessage, handleCreateTimeline, handleAddPost, handleDeletePost, toggleLock, requestAddFamily, acceptRequest, declineRequest, saveUsers }) {
  const [showRequests, setShowRequests] = useState(false);
  const users = read(USERS_KEY);
  const pending = getPendingRequests(user.username);

  function signout() { signOut(); setUser(null); }

  return (
    <div className="p-4 max-w-6xl mx-auto">
      <header className="flex justify-between items-center mb-6">
        <div className="flex items-center gap-4">
          <div style={{ width: 44, height: 44, borderRadius: 8, background: fb.blue }} />
          <div>
            <h1 className="text-2xl font-bold">Moments</h1>
            <div className="text-sm text-slate-500">A friend & memory focused app</div>
          </div>
        </div>

        <div className="flex items-center gap-3">
          <div className="hidden sm:block">Hello, <b>{user.username}</b>{user.isStar ? " ⭐" : ""}</div>
          <button onClick={() => setShowRequests(true)} className="px-3 py-2 border rounded flex items-center gap-2">
            Requests {pending.length > 0 && <span className="text-xs bg-amber-500 text-black px-2 py-0.5 rounded">{pending.length}</span>}
          </button>
          <button onClick={signout} className="px-3 py-2 border rounded">Sign out</button>
        </div>
      </header>

      <div className="flex gap-4">
        <nav className="flex flex-col gap-2 w-48">
          <button onClick={() => setView('timelines')} className={`px-3 py-3 rounded text-left ${view === 'timelines' ? 'bg-[${fb.blue}] text-white' : 'border'}`} style={{ background: view === 'timelines' ? fb.blue : undefined, color: view === 'timelines' ? 'white' : undefined }}>Timelines</button>
          <button onClick={() => setView('feed')} className={`px-3 py-3 rounded text-left ${view === 'feed' ? 'bg-[${fb.blue}] text-white' : 'border'}`} style={{ background: view === 'feed' ? fb.blue : undefined, color: view === 'feed' ? 'white' : undefined }}>Feed</button>
          <button onClick={() => setView('chat')} className={`px-3 py-3 rounded text-left ${view === 'chat' ? 'bg-[${fb.blue}] text-white' : 'border'}`} style={{ background: view === 'chat' ? fb.blue : undefined, color: view === 'chat' ? 'white' : undefined }}>Chat</button>
          <button onClick={() => setView('family')} className={`px-3 py-3 rounded text-left ${view === 'family' ? 'bg-[${fb.blue}] text-white' : 'border'}`} style={{ background: view === 'family' ? fb.blue : undefined, color: view === 'family' ? 'white' : undefined }}>Family</button>
          <button onClick={() => setView('memory')} className={`px-3 py-3 rounded text-left ${view === 'memory' ? 'bg-[${fb.blue}] text-white' : 'border'}`} style={{ background: view === 'memory' ? fb.blue : undefined, color: view === 'memory' ? 'white' : undefined }>Memory Lane</button>
          <button onClick={() => setView('shop')} className={`px-3 py-3 rounded text-left ${view === 'shop' ? 'bg-[${fb.blue}] text-white' : 'border'}`} style={{ background: view === 'shop' ? fb.blue : undefined, color: view === 'shop' ? 'white' : undefined }}>Shop</button>
        </nav>

        <main className="flex-1">
          {view === 'timelines' && <Timelines user={user} timelines={timelines} handleCreateTimeline={handleCreateTimeline} handleAddPost={handleAddPost} handleDeletePost={handleDeletePost} toggleLock={toggleLock} />}
          {view === 'feed' && <Feed user={user} timelines={timelines} />}
          {view === 'chat' && <Chat user={user} messages={messages} sendMessage={sendMessage} />}
          {view === 'family' && <Family user={user} timelines={timelines} messages={messages} requestAddFamily={requestAddFamily} />}
          {view === 'memory' && <MemoryLane user={user} timelines={timelines} />}
          {view === 'shop' && <Shop />}
        </main>
      </div>

      {showRequests && (
        <div className="fixed inset-0 flex items-center justify-center bg-black/40 p-4 z-50">
          <div className="bg-white rounded p-4 max-w-md w-full">
            <h3 className="font-bold mb-3">Friend Requests</h3>
            {pending.length === 0 && <div className="text-slate-500">No requests.</div>}
            <div className="space-y-2 max-h-64 overflow-y-auto">
              {pending.map((from) => (
                <div key={from} className="flex items-center justify-between bg-slate-50 p-2 rounded">
                  <div>{from}</div>
                  <div className="flex gap-2">
                    <button onClick={() => { acceptRequest(from); }} className="px-3 py-1 bg-green-600 text-white rounded">Accept</button>
                    <button onClick={() => { declineRequest(from); }} className="px-3 py-1 border rounded">Decline</button>
                  </div>
                </div>
              ))}
            </div>
            <div className="mt-3 flex justify-end">
              <button onClick={() => setShowRequests(false)} className="px-3 py-1 border rounded">Close</button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}

function Timelines({ user, timelines, handleCreateTimeline, handleAddPost, handleDeletePost, toggleLock }) {
  const [showCreate, setShowCreate] = useState(false);
  const myT = Object.values(timelines).filter(t => t.owner === user.username).sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

  return (
    <div>
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-xl font-semibold">Your Timelines</h2>
        <button onClick={() => setShowCreate(true)} className="px-4 py-2 rounded text-white" style={{ background: fb.blue }}>Create timeline</button>
      </div>

      {showCreate && <TimelineCreateModal onClose={() => setShowCreate(false)} onCreate={handleCreateTimeline} />}

      <div className="grid gap-4">
        {myT.map(t => <Timeline key={t.id} timeline={t} isOwner handleAddPost={handleAddPost} handleDeletePost={handleDeletePost} toggleLock={toggleLock} />)}
      </div>
    </div>
  );
}

function TimelineCreateModal({ onClose, onCreate }) {
  const [name, setName] = useState("");
  const [iconFile, setIconFile] = useState(null);
  const [locked, setLocked] = useState(true);
  const [startDate, setStartDate] = useState(new Date().toISOString().slice(0, 16)); // local datetime-local value
  const [description, setDescription] = useState("");

  function submit() {
    const reader = new FileReader();
    if (iconFile) {
      reader.onload = () => {
        onCreate({ name, iconDataUrl: reader.result, locked, startDate: new Date(startDate).getTime(), description });
        onClose();
      };
      reader.readAsDataURL(iconFile);
    } else {
      onCreate({ name, iconDataUrl: null, locked, startDate: new Date(startDate).getTime(), description });
      onClose();
    }
  }

  return (
    <div className="fixed inset-0 flex items-center justify-center bg-black/40 p-4 z-50">
      <div className="bg-white rounded p-4 max-w-lg w-full">
        <h3 className="font-bold mb-2">Create Timeline</h3>
        <div className="space-y-2">
          <input className="w-full p-2 border rounded" placeholder="Timeline name" value={name} onChange={e => setName(e.target.value)} />
          <textarea className="w-full p-2 border rounded" placeholder="Short description (optional)" value={description} onChange={e => setDescription(e.target.value)} />
          <div className="flex gap-2">
            <input type="file" accept="image/*" onChange={e => setIconFile(e.target.files[0])} />
            <label className="flex items-center gap-2"><input type="checkbox" checked={locked} onChange={e => setLocked(e.target.checked)} /> Private (locked)</label>
          </div>
          <label className="block text-sm text-slate-500">Timeline start date/time (used to order timelines and initial zoom)</label>
          <input type="datetime-local" className="w-full p-2 border rounded" value={startDate} onChange={e => setStartDate(e.target.value)} />
        </div>
        <div className="mt-4 flex justify-end gap-2">
          <button onClick={onClose} className="px-3 py-1 border rounded">Cancel</button>
          <button onClick={submit} className="px-3 py-1 rounded text-white" style={{ background: fb.blue }}>Create</button>
        </div>
      </div>
    </div>
  );
}

function Timeline({ timeline, isOwner, handleAddPost, handleDeletePost, toggleLock }) {
  const [open, setOpen] = useState(false);
  const [text, setText] = useState("");
  const [file, setFile] = useState(null);
  const [postDate, setPostDate] = useState(new Date().toISOString().slice(0, 16));

  // ensure posts are ordered by created time (ascending)
  const posts = (timeline.posts || []).slice().sort((a, b) => new Date(a.created) - new Date(b.created));

  function addText() {
    if (!text) return;
    handleAddPost(timeline.id, { content: text, type: 'text', createdAt: new Date(postDate).getTime() });
    setText('');
  }

  function uploadFile() {
    if (!file) return;
    const url = URL.createObjectURL(file);
    handleAddPost(timeline.id, { content: { name: file.name, type: file.type, url }, type: 'file', createdAt: new Date(postDate).getTime() });
    setFile(null);
  }

  return (
    <div className="bg-white p-4 rounded-xl shadow mb-4">
      <div className="flex justify-between items-center mb-2">
        <div className="flex items-center gap-3">
          <button aria-label={open ? "Close timeline" : "Open timeline"} onClick={() => setOpen(!open)} className="p-2 rounded hover:bg-slate-100">
            <svg className={`w-5 h-5 text-slate-700 transform ${open ? 'rotate-180' : ''}`} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={2}><path strokeLinecap="round" strokeLinejoin="round" d="M9 5l7 7-7 7" /></svg>
          </button>

          <div className="flex items-center gap-2 cursor-pointer" onClick={() => setOpen(!open)}>
            {timeline.icon && <img src={timeline.icon} alt="" className="w-10 h-10 rounded-full" />}
            <div>
              <h3 className="font-bold">{timeline.name}</h3>
              <div className="text-xs text-slate-500">{timeline.owner} • starts {new Date(timeline.startDate).toLocaleString()}</div>
            </div>
          </div>
        </div>

        {isOwner && (
          <div className="flex items-center gap-2">
            <button onClick={() => toggleLock(timeline.id)} className="text-sm px-3 py-2 border rounded">{timeline.locked ? "🔒 Private" : "🔓 Unlocked"}</button>
          </div>
        )}
      </div>

      {open && (
        <>
          {isOwner && (
            <div className="mb-3 space-y-2">
              <div className="flex gap-2 items-center">
                <textarea className="flex-1 border p-2 rounded" placeholder="Write something..." value={text} onChange={e => setText(e.target.value)} />
                <div className="text-sm">
                  <label className="block text-xs text-slate-500">Post date/time</label>
                  <input type="datetime-local" value={postDate} onChange={e => setPostDate(e.target.value)} className="border p-1 rounded" />
                </div>
              </div>
              <div className="flex gap-2">
                <button onClick={addText} className="px-3 py-1 rounded text-white" style={{ background: fb.blue }}>Add Text</button>
                <input type="file" onChange={e => setFile(e.target.files[0])} />
                <button onClick={uploadFile} className="px-3 py-1 border rounded">Upload</button>
              </div>
            </div>
          )}

          <div className="relative pl-8">
            <div className="absolute left-4 top-6 bottom-0 w-0.5 bg-slate-300"></div>
            <div className="space-y-6">
              {posts.map((p) => (
                <div key={p.id} className="relative">
                  <div className="absolute -left-6 top-3 w-3 h-3" style={{ background: fb.blue, borderRadius: '9999px' }}></div>
                  <div className="bg-white p-3 rounded-xl shadow">
                    <div className="flex justify-between items-center mb-1 text-xs text-slate-500">
                      <span>{p.owner} • {new Date(p.created).toLocaleString()}</span>
                      {isOwner && <button onClick={() => handleDeletePost(timeline.id, p.id)} className="text-red-600 text-xs">✕</button>}
                    </div>
                    {p.type === "text" && <div>{p.content}</div>}
                    {p.type === "file" && (
                      p.content.type.startsWith("image") ? <img src={p.content.url} alt="" className="w-full h-48 object-cover rounded" /> : <video src={p.content.url} controls className="w-full h-48 rounded" />
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>
        </>
      )}
    </div>
  );
}

function Feed({ user, timelines }) {
  const users = read(USERS_KEY);
  const myFriends = getFriends(user.username);
  const allVisible = Object.values(timelines).filter(t => {
    if (!t.locked) {
      const owner = t.owner;
      return myFriends.includes(owner) || users[owner]?.isStar;
    }
    return false;
  }).sort((a, b) => new Date(b.startDate) - new Date(a.startDate));

  return (
    <div>
      <h2 className="text-xl font-semibold mb-4">Feed (Unlocked posts from family or Star members)</h2>
      {allVisible.length === 0 && <div className="text-slate-500">No unlocked posts visible to you yet.</div>}
      <div className="grid gap-3">
        {allVisible.map(t => (
          <div key={t.id} className="bg-white p-3 rounded shadow">
            <div className="flex justify-between items-center mb-2">
              <div>
                <div className="font-bold">{t.name} <span className="text-xs text-slate-500">by {t.owner}</span></div>
                <div className="text-xs text-slate-400">{myFriends.includes(t.owner) ? "Family" : "Star"}{users[t.owner]?.isStar ? " • Star" : ""}</div>
              </div>
            </div>
            <div className="flex gap-3 overflow-x-auto">
              {t.posts.map(p => (
                <div key={p.id} className="min-w-[220px]">
                  <div className="bg-slate-50 p-3 rounded">
                    {p.type === "text" ? p.content : (p.content.name)}
                    <div className="text-xs text-slate-400 mt-2">{new Date(p.created).toLocaleString()}</div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

function Chat({ user, messages, sendMessage }) {
  const users = read(USERS_KEY);
  const myFriends = getFriends(user.username);
  const family = myFriends.filter(u => u in users);
  const [selected, setSelected] = useState(family[0] || null);
  const [text, setText] = useState("");

  useEffect(() => { if (!selected && family[0]) setSelected(family[0]); }, [family]);

  return (
    <div className="flex flex-col sm:flex-row gap-4">
      <aside className="w-full sm:w-48 bg-white rounded shadow p-2 max-h-[60vh] overflow-y-auto">
        <h4 className="font-semibold mb-2">Family Contacts</h4>
        {family.length === 0 && <div className="text-slate-500">No family contacts. Add family from the Family tab.</div>}
        {family.map(o => (
          <div key={o} className={`p-3 rounded cursor-pointer flex items-center justify-between ${selected === o ? "bg-slate-100" : ""}`} onClick={() => setSelected(o)}>
            <div>{o}{users[o]?.isStar ? " ⭐" : ""}</div>
          </div>
        ))}
      </aside>

      <section className="flex-1 bg-white rounded shadow p-3 flex flex-col">
        {selected ? (
          <>
            <div className="flex-1 overflow-y-auto mb-2 max-h-[60vh]">
              {(messages[selected] || []).map((m, i) => (
                <div key={i} className={`mb-2 ${m.from === selected ? "text-left" : "text-right"}`}>
                  <div className="inline-block px-3 py-1 rounded text-sm bg-slate-100">{m.from}: {m.text}</div>
                </div>
              ))}
            </div>
            <form onSubmit={e => { e.preventDefault(); if (text) { sendMessage(selected, text); setText(""); } }} className="flex gap-2">
              <input className="flex-1 border rounded p-3" placeholder="Message..." value={text} onChange={e => setText(e.target.value)} />
              <button className="px-4 py-2 rounded text-white" style={{ background: fb.blue }}>Send</button>
            </form>
          </>
        ) : <div className="text-slate-500">No family selected</div>}
      </section>
    </div>
  );
}

function Family({ user, timelines, messages, requestAddFamily }) {
  const users = read(USERS_KEY);
  const myFriends = getFriends(user.username);
  const [search, setSearch] = useState("");
  const others = Object.keys(users).filter(u => u !== user.username && u.includes(search));

  function add(u) { try { requestAddFamily(u); } catch (e) { alert(e.message); } }

  return (
    <div>
      <h2 className="text-xl font-semibold mb-4">Family</h2>
      <input className="w-full border p-3 rounded mb-4" placeholder="Search users..." value={search} onChange={e => setSearch(e.target.value)} />

      <ul className="space-y-2 mb-6">
        {others.map(u => <li key={u} className="bg-white p-3 rounded shadow flex justify-between items-center">
          <div>
            <div className="font-medium">{u}{users[u]?.isStar ? " ⭐" : ""}</div>
            <div className="text-xs text-slate-500">{users[u]?.pendingRequests?.includes(user.username) ? "Request sent" : ""}</div>
          </div>
          <div className="flex gap-2">
            <button onClick={() => add(u)} className="px-3 py-1 border rounded">{users[u]?.pendingRequests?.includes(user.username) ? "Requested" : "Add Family"}</button>
          </div>
        </li>)}
      </ul>

      <h3 className="font-bold mb-2">Your Family</h3>
      {myFriends.length === 0 && <div className="text-slate-500">No family yet.</div>}
      {myFriends.map(f => <FamilyMember key={f} me={user.username} friend={f} timelines={timelines} messages={messages?.[user.username]?.[f] || []} />)}
    </div>
  );
}

function FamilyMember({ me, friend, timelines, messages }) {
  const friendTimelines = Object.values(timelines).filter(t => t.owner === friend && !t.locked);
  return (
    <div className="mb-6">
      <h4 className="font-semibold mb-2">{friend}'s Timelines</h4>
      {friendTimelines.length === 0 && <div className="text-slate-500 mb-4">No visible timelines.</div>}
      {friendTimelines.map(tl => <Timeline key={tl.id} timeline={tl} isOwner={false} />)}
    </div>
  );
}

function MemoryLane({ user, timelines }) {
  const today = new Date();
  const memories = [];
  Object.values(timelines).forEach(t => {
    t.posts?.forEach(p => {
      const d = new Date(p.created);
      if (d.getDate() === today.getDate() && d.getMonth() === today.getMonth()) memories.push({ ...p, timeline: t.name });
    });
  });
  return (
    <div>
      <h2 className="text-xl font-semibold mb-4">Memory Lane</h2>
      {memories.length === 0 && <div className="text-slate-500">No memories today.</div>}
      {memories.map((m, i) => (
        <div key={i} className="bg-white p-3 rounded shadow mb-2">
          <div className="text-xs text-slate-500">From {m.timeline}</div>
          <div>{m.type === "text" ? m.content : m.content.name}</div>
        </div>
      ))}
    </div>
  );
}

function Shop() {
  return (
    <div className="bg-white p-6 rounded shadow text-center">
      <h2 className="text-xl font-semibold mb-3">Shop</h2>
      <div className="text-slate-500">to come...</div>
    </div>
  );
}
