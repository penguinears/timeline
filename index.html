<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Moments — Star Program</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;
    const uid = () => Math.random().toString(36).slice(2,9);

    const USERS_KEY = "moments_users";
    const SESSION_KEY = "moments_session";
    const TIMELINES_KEY = "moments_timelines";
    const MESSAGES_KEY = "moments_messages";

    function read(key){ try{return JSON.parse(localStorage.getItem(key))||{}}catch{return{}} }
    function write(key,val){ localStorage.setItem(key,JSON.stringify(val)); }

    function createAccount(username,password,isStar=false){
      const users=read(USERS_KEY);
      if(users[username]) throw new Error("username taken");
      users[username]={username,password,id:uid(),friends:[],isStar};
      write(USERS_KEY,users);
    }
    function signIn(username,password){
      const users=read(USERS_KEY);
      if(!users[username]) throw new Error("no such user");
      if(users[username].password!==password) throw new Error("wrong password");
      write(SESSION_KEY,{username});
      return users[username];
    }
    function signOut(){ localStorage.removeItem(SESSION_KEY); }
    function currentSession(){ return read(SESSION_KEY); }

    function addFriend(user,friend){
      const users=read(USERS_KEY);
      if(!users[user].friends.includes(friend)){
        users[user].friends.push(friend);
        write(USERS_KEY,users);
      }
    }
    function getFriends(user){ const users=read(USERS_KEY); return users[user]?.friends||[]; }

    function MomentsApp(){
      const [user,setUser]=useState(null);
      const [view,setView]=useState("timelines");
      const [timelines,setTimelines]=useState(read(TIMELINES_KEY));
      const [messages,setMessages]=useState(read(MESSAGES_KEY));
      const channelRef=useRef(null);

      useEffect(()=>{
        const session=currentSession();
        if(session?.username){
          const users=read(USERS_KEY);
          if(users[session.username]) setUser(users[session.username]);
        }
      },[]);

      useEffect(()=>{
        channelRef.current=new BroadcastChannel("moments_channel");
        channelRef.current.onmessage=(e)=>{
          if(e.data.type==="message"){
            setMessages(prev=>{
              const m={...prev};
              if(!m[e.data.to]) m[e.data.to]={};
              if(!m[e.data.to][e.data.from]) m[e.data.to][e.data.from]=[];
              m[e.data.to][e.data.from].push(e.data.msg);
              write(MESSAGES_KEY,m);
              return m;
            });
          }
          if(e.data.type==="timelines_update"){
            setTimelines(read(TIMELINES_KEY));
          }
        };
        return ()=>channelRef.current.close();
      },[]);

      function saveTimelines(updated){
        setTimelines(updated); write(TIMELINES_KEY,updated);
        if(channelRef.current) channelRef.current.postMessage({type:"timelines_update"});
      }

      function handleCreateTimeline(name,iconFile){
        const reader=new FileReader();
        reader.onload=()=>{
          const newT={id:uid(),name,owner:user.username,posts:[],locked:false,icon:reader.result};
          saveTimelines({...timelines,[newT.id]:newT});
        };
        if(iconFile) reader.readAsDataURL(iconFile);
        else{
          const newT={id:uid(),name,owner:user.username,posts:[],locked:false,icon:null};
          saveTimelines({...timelines,[newT.id]:newT});
        }
      }

      function handleAddPost(tid,content,type){
        const t={...timelines[tid]};
        t.posts.push({id:uid(),owner:user.username,type,content,created:Date.now()});
        saveTimelines({...timelines,[tid]:t});
      }

      function handleDeletePost(tid,pid){
        const t={...timelines[tid], posts: timelines[tid].posts.filter(p=>p.id!==pid)};
        saveTimelines({...timelines,[tid]:t});
      }

      function toggleLock(tid){
        const t={...timelines[tid]};
        t.locked=!t.locked;
        saveTimelines({...timelines,[tid]:t});
      }

      function sendMessage(to,text){
        const msg={from:user.username,to,text,time:Date.now()};
        const m={...messages};
        if(!m[user.username]) m[user.username]={};
        if(!m[user.username][to]) m[user.username][to]=[];
        m[user.username][to].push(msg);

        if(!m[to]) m[to]={};
        if(!m[to][user.username]) m[to][user.username]=[];
        m[to][user.username].push(msg);

        setMessages(m); write(MESSAGES_KEY,m);
        if(channelRef.current) channelRef.current.postMessage({type:"message",to,from:user.username,msg});
      }

      return user
        ? <Dashboard user={user} setUser={setUser} view={view} setView={setView} timelines={timelines} messages={messages} sendMessage={sendMessage} handleCreateTimeline={handleCreateTimeline} handleAddPost={handleAddPost} handleDeletePost={handleDeletePost} toggleLock={toggleLock} />
        : <AuthPanel setUser={setUser} />;
    }

    function AuthPanel({setUser}){
      const [mode,setMode]=useState("signin");
      const [u,setU]=useState(""),[p,setP]=useState(""),[err,setErr]=useState("");
      const [isStar,setIsStar]=useState(false);
      const [showWarning,setShowWarning]=useState(false);

      function submit(e){ e.preventDefault();
        try{
          if(mode==="signup"){
            if(isStar){ setShowWarning(true); return; }
            createAccount(u,p,false);
          }
          signIn(u,p);
          setUser(currentSession());
        }catch(e){setErr(e.message);}      }

      function confirmStarSignup(){
        try{
          createAccount(u,p,true);
          signIn(u,p);
          setUser(currentSession());
          setShowWarning(false);
        }catch(e){setErr(e.message); setShowWarning(false);}      }

      return(
        <div className="p-6 bg-white rounded-xl shadow max-w-md mx-auto mt-12">
          <h2 className="text-xl font-bold mb-3">{mode==="signin"?"Sign In":"Create Account"}</h2>
          <form onSubmit={submit} className="space-y-2">
            <input className="w-full p-2 border rounded" placeholder="username" value={u} onChange={e=>setU(e.target.value)} />
            <input className="w-full p-2 border rounded" placeholder="password" type="password" value={p} onChange={e=>setP(e.target.value)} />
            {mode==="signup" && (
              <label className="flex items-center gap-2">
                <input type="checkbox" checked={isStar} onChange={e=>setIsStar(e.target.checked)} />
                Join the Star Program (public visibility for unlocked posts)
              </label>
            )}
            {err && <div className="text-red-600 text-sm">{err}</div>}
            <button className="w-full px-3 py-2 bg-slate-900 text-white rounded">{mode==="signin"?"Sign in":"Sign up"}</button>
          </form>

          <button onClick={()=>setMode(mode==="signin"?"signup":"signin")} className="w-full mt-3 px-3 py-2 border rounded">{mode==="signin"?"Need an account? Sign up":"Have an account? Sign in"}</button>

          {showWarning && (
            <div className="fixed inset-0 flex items-center justify-center bg-black/40 p-4">
              <div className="bg-white rounded p-4 max-w-md w-full">
                <h3 className="font-bold mb-2">Star Program — public visibility</h3>
                <p className="text-sm mb-3">Unlocked posts will be visible to everyone. Are you sure?</p>
                <div className="flex gap-2 justify-end">
                  <button onClick={()=>setShowWarning(false)} className="px-3 py-1 border rounded">Cancel</button>
                  <button onClick={confirmStarSignup} className="px-3 py-1 bg-amber-500 text-black rounded">Yes, join</button>
                </div>
              </div>
            </div>
          )}
        </div>
      )
    }

    function Dashboard({user,setUser,view,setView,timelines,messages,sendMessage,handleCreateTimeline,handleAddPost,handleDeletePost,toggleLock}){
      return(
        <div className="p-4 max-w-6xl mx-auto">
          <div className="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 gap-3">
            <div className="flex items-center gap-3">
              <h1 className="text-2xl font-bold">Moments</h1>
            </div>
            <div className="flex gap-3 items-center">
              <div>Hello, <b>{user.username}</b>{user.isStar?" ⭐":""}</div>
              <button onClick={()=>{signOut();setUser(null)}} className="px-2 py-1 border rounded">Sign out</button>
            </div>
          </div>

          <div className="flex flex-col sm:flex-row gap-4">
            <nav className="flex sm:flex-col gap-2 sm:w-48 w-full">
              <button onClick={()=>setView("timelines")} className={`px-3 py-2 rounded text-left ${view==="timelines"?"bg-slate-900 text-white":"border"}`}>Timelines</button>
              <button onClick={()=>setView("feed")} className={`px-3 py-2 rounded text-left ${view==="feed"?"bg-slate-900 text-white":"border"}`}>Feed</button>
            </nav>

            <main className="flex-1">
              {view==="timelines" && <Timelines user={user} timelines={timelines} handleCreateTimeline={handleCreateTimeline} handleAddPost={handleAddPost} handleDeletePost={handleDeletePost} toggleLock={toggleLock} />}
              {view==="feed" && <Feed user={user} timelines={timelines} />}
            </main>
          </div>
        </div>
      )
    }

    function Timelines({user,timelines,handleCreateTimeline,handleAddPost,handleDeletePost,toggleLock}){
      const [name,setName]=useState("");
      const [iconFile,setIconFile]=useState(null);
      const myT=Object.values(timelines).filter(t=>t.owner===user.username);
      return(
        <div>
          <h2 className="text-xl font-semibold mb-4">Your Timelines</h2>
          <div className="flex flex-col sm:flex-row gap-2 mb-4">
            <input className="flex-1 p-2 border rounded" placeholder="New timeline name" value={name} onChange={e=>setName(e.target.value)} />
            <input type="file" accept="image/*" onChange={e=>setIconFile(e.target.files[0])} />
            <button onClick={()=>{if(name){handleCreateTimeline(name,iconFile);setName("");setIconFile(null);}}} className="px-3 py-1 bg-slate-900 text-white rounded">Create</button>
          </div>
          <div className="grid gap-4">
            {myT.map(t=><Timeline key={t.id} timeline={t} isOwner handleAddPost={handleAddPost} handleDeletePost={handleDeletePost} toggleLock={toggleLock} />)}
          </div>
        </div>
      )
    }

    function Timeline({timeline,isOwner,handleAddPost,handleDeletePost,toggleLock}){
      const [text,setText]=useState("");
      const [file,setFile]=useState(null);
      const [open,setOpen]=useState(false);
      return(
        <div className="bg-white p-4 rounded-xl shadow mb-4">
          <div className="flex justify-between items-center mb-2">
            <div className="flex items-center gap-2">
              <button onClick={()=>setOpen(!open)} className="text-lg">{open?"⬆":"⬇"}</button>
              {timeline.icon && <img src={timeline.icon} alt="" className="w-8 h-8 rounded-full" />}
              <div>
                <h3 className="font-bold">{timeline.name}</h3>
                <div className="text-xs text-slate-500">{timeline.owner}</div>
              </div>
            </div>
            {isOwner && (
              <button onClick={()=>toggleLock(timeline.id)} className="text-sm px-2 py-1 border rounded">{timeline.locked?"🔒":"🔓"}</button>
            )}
          </div>
          {open && (
            <>
              {isOwner && (
                <div className="mb-3 space-y-2">
                  <textarea className="w-full border p-2 rounded" placeholder="Write something..." value={text} onChange={e=>setText(e.target.value)} />
                  <div className="flex gap-2 flex-wrap">
                    <button onClick={()=>text && handleAddPost(timeline.id,text,"text")} className="px-3 py-1 bg-slate-900 text-white rounded">Add Text</button>
                    <input type="file" onChange={e=>setFile(e.target.files[0])} />
                    <button onClick={()=>file && handleAddPost(timeline.id,{name:file.name,type:file.type,url:URL.createObjectURL(file)},"file")} className="px-3 py-1 border rounded">Upload</button>
                  </div>
                </div>
              )}
              <div className="flex gap-4 overflow-x-auto pb-4">
                {timeline.posts.map((p)=><PostCard key={p.id} p={p} isOwner={isOwner} timelineId={timeline.id} handleDeletePost={handleDeletePost} />)}
              </div>
            </>
          )}
        </div>
      )
    }

    function PostCard({p,isOwner,timelineId,handleDeletePost}){
      return(
        <div className="relative z-10 flex-shrink-0 min-w-[220px]">
          <div className={`bg-white border rounded-xl p-3 shadow text-sm`}>
            <div className="flex justify-between items-center mb-1 text-xs text-slate-500">
              <span>{p.owner} • {new Date(p.created).toLocaleString()}</span>
              {isOwner && <button onClick={()=>handleDeletePost(timelineId,p.id)} className="text-red-600 text-xs">✕</button>}
            </div>
            {p.type==="text" && <div>{p.content}</div>}
            {p.type==="file" && (
              p.content.type.startsWith("image") ?
                <img src={p.content.url} alt="" className="w-full h-32 object-cover rounded"/> :
                <video src={p.content.url} controls className="w-full h-32 rounded" />
            )}
          </div>
        </div>
      )
    }

    function Feed({user,timelines}){
      const users=read(USERS_KEY);
      const myFriends=getFriends(user.username);
      // SHOW ONLY unlocked timelines if: owner is Star Program OR is my friend
      const visible=Object.values(timelines).filter(t=>{
        const owner=users[t.owner];
        return !t.locked && (owner?.isStar || myFriends.includes(t.owner));
      });

      return(
        <div>
          <h2 className="text-xl font-semibold mb-4">Feed</h2>
          {visible.length===0 && <div className="text-slate-500">No visible posts.</div>}
          <div className="grid gap-3">
            {visible.map(t=> (
              <div key={t.id} className="bg-white p-3 rounded shadow">
                <div className="flex justify-between items-center mb-2">
                  <div>
                    <div className="font-bold">{t.name} <span className="text-xs text-slate-500">by {t.owner}</span></div>
                    <div className="text-xs text-slate-400">{myFriends.includes(t.owner)?"Friend":"Star Program"}</div>
                  </div>
                </div>
                <div className="flex gap-3 overflow-x-auto">
                  {t.posts.map(p=>(<div key={p.id} className="min-w-[220px] bg-slate-50 p-3 rounded">{p.type==="text"?p.content:p.content.name}</div>))}
                </div>
              </div>
            ))}
          </div>
        </div>
      )
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<MomentsApp/>);
  </script>
</body>
</html>
